name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # 构建 Rust 预编译二进制
  build-rust-binaries:
    name: Build Rust binary (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          # Linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          # Linux musl (static)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Install musl tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Build binary (cross)
        if: matrix.cross
        working-directory: implementations/rust
        run: cross build --release --target ${{ matrix.target }}

      - name: Build binary (native)
        if: '!matrix.cross'
        working-directory: implementations/rust
        run: cargo build --release --target ${{ matrix.target }}

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="v${{ github.event.inputs.version }}"
          fi
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        working-directory: implementations/rust
        run: |
          BINARY_NAME="dxc"
          ARCHIVE_NAME="dxcode-v${{ steps.version.outputs.version }}-${{ matrix.target }}"

          mkdir -p dist
          cp "target/${{ matrix.target }}/release/${BINARY_NAME}" dist/
          cp README.md dist/ 2>/dev/null || true
          cp ../../LICENSE dist/ 2>/dev/null || true

          cd dist
          tar -czvf "../${ARCHIVE_NAME}.tar.gz" *
          cd ..

          # Generate checksum
          shasum -a 256 "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        working-directory: implementations/rust
        shell: pwsh
        run: |
          $BINARY_NAME = "dxc.exe"
          $ARCHIVE_NAME = "dxcode-v${{ steps.version.outputs.version }}-${{ matrix.target }}"

          New-Item -ItemType Directory -Force -Path dist
          Copy-Item "target/${{ matrix.target }}/release/${BINARY_NAME}" dist/
          Copy-Item README.md dist/ -ErrorAction SilentlyContinue
          Copy-Item ../../LICENSE dist/ -ErrorAction SilentlyContinue

          Compress-Archive -Path dist/* -DestinationPath "${ARCHIVE_NAME}.zip"

          # Generate checksum
          (Get-FileHash "${ARCHIVE_NAME}.zip" -Algorithm SHA256).Hash.ToLower() + "  ${ARCHIVE_NAME}.zip" | Out-File "${ARCHIVE_NAME}.zip.sha256" -Encoding ascii

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dxcode-${{ matrix.target }}
          path: |
            implementations/rust/*.tar.gz
            implementations/rust/*.tar.gz.sha256
            implementations/rust/*.zip
            implementations/rust/*.zip.sha256
          if-no-files-found: error

  # 上传二进制到 Release
  upload-release-assets:
    name: Upload release assets
    runs-on: ubuntu-latest
    needs: build-rust-binaries
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: dxcode-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 发布到 crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: build-rust-binaries
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        working-directory: implementations/rust
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_TOKEN }}

  # 发布 npm 主库 (dxcode)
  publish-npm-lib:
    name: Publish npm library
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies and test
        working-directory: implementations/javascript
        run: |
          npm install
          npm test

      - name: Publish to npm
        working-directory: implementations/javascript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # 发布 npm CLI (dxcode-cli) - 保留作为备选
  publish-npm-cli:
    name: Publish npm CLI
    runs-on: ubuntu-latest
    needs: publish-npm-lib
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Wait for npm registry to update
        run: sleep 30

      - name: Publish CLI to npm
        working-directory: implementations/javascript/cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # 发布 PyPI (dxcode)
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        working-directory: implementations/python
        run: |
          rm -rf dist/ build/ *.egg-info/
          python -m build

      - name: Publish to PyPI
        working-directory: implementations/python
        run: twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # 更新 Homebrew tap (Rust binary)
  update-homebrew:
    name: Update Homebrew tap
    runs-on: macos-latest
    needs: upload-release-assets
    if: github.event_name == 'release'
    steps:
      - name: Get release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: sleep 30

      - name: Download and get SHA256
        id: sha
        run: |
          # macOS arm64
          curl -sLO "https://github.com/dogxii/dxcode/releases/download/v${{ steps.release.outputs.version }}/dxcode-v${{ steps.release.outputs.version }}-aarch64-apple-darwin.tar.gz"
          SHA_ARM64=$(shasum -a 256 dxcode-v${{ steps.release.outputs.version }}-aarch64-apple-darwin.tar.gz | cut -d' ' -f1)
          echo "sha_arm64=${SHA_ARM64}" >> $GITHUB_OUTPUT

          # macOS x86_64
          curl -sLO "https://github.com/dogxii/dxcode/releases/download/v${{ steps.release.outputs.version }}/dxcode-v${{ steps.release.outputs.version }}-x86_64-apple-darwin.tar.gz"
          SHA_X64=$(shasum -a 256 dxcode-v${{ steps.release.outputs.version }}-x86_64-apple-darwin.tar.gz | cut -d' ' -f1)
          echo "sha_x64=${SHA_X64}" >> $GITHUB_OUTPUT

          # Linux x86_64
          curl -sLO "https://github.com/dogxii/dxcode/releases/download/v${{ steps.release.outputs.version }}/dxcode-v${{ steps.release.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz"
          SHA_LINUX=$(shasum -a 256 dxcode-v${{ steps.release.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz | cut -d' ' -f1)
          echo "sha_linux=${SHA_LINUX}" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          repository: dogxii/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        working-directory: homebrew-tap
        run: |
          cat > dxcode.rb << 'EOF'
          class Dxcode < Formula
            desc "A distinctive, URL-safe binary encoder with the signature `dx` prefix"
            homepage "https://dxc.dogxi.me"
            version "${{ steps.release.outputs.version }}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/dogxii/dxcode/releases/download/v${{ steps.release.outputs.version }}/dxcode-v${{ steps.release.outputs.version }}-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.sha.outputs.sha_arm64 }}"
              end
              on_intel do
                url "https://github.com/dogxii/dxcode/releases/download/v${{ steps.release.outputs.version }}/dxcode-v${{ steps.release.outputs.version }}-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.sha.outputs.sha_x64 }}"
              end
            end

            on_linux do
              url "https://github.com/dogxii/dxcode/releases/download/v${{ steps.release.outputs.version }}/dxcode-v${{ steps.release.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz"
              sha256 "${{ steps.sha.outputs.sha_linux }}"
            end

            def install
              bin.install "dxc"
            end

            test do
              assert_match "dxcode", shell_output("#{bin}/dxc --help")
              encoded = shell_output("#{bin}/dxc encode Hello").strip
              assert encoded.start_with?("dx")
              decoded = shell_output("#{bin}/dxc decode #{encoded}").strip
              assert_equal "Hello", decoded
            end
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dxcode.rb
          git diff --staged --quiet || git commit -m "Update dxcode to v${{ steps.release.outputs.version }}"
          git push
